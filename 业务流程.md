# 一、核心方法
### 1.1、updateIndexes - 指数更新
**业务逻辑流程：**
1. 检查当前时间戳是否大于最后更新时间戳
2. 计算时间差（当前时间 - 最后更新时间）
3. 获取当前资金利用率
4. 如果利用率 > 0：
    - 计算借款利率（年化）
    - 计算存款利率（年化）
    - 更新借款指数：基于复利公式 `borrowIndex = borrowIndex * (1 + borrowRate * timeDelta / SECONDS_PER_YEAR)`
    - 更新存款指数：基于复利公式 `liquidityIndex = liquidityIndex * (1 + supplyRate * timeDelta / SECONDS_PER_YEAR)`
5. 更新最后时间戳为当前时间

###  1.2、depositLend - 存款功能
**业务逻辑流程：**
1. 验证存款金额 > 0
2. 更新指数系统
3. 从用户转移USDC到合约
4. 增加总存款本金
5. 记录用户存款信息：
    - 本金金额
    - 当前存款指数快照
    - 时间戳
6. 触发存款事件

### 1.3、depositLendWithdraw - 取款功能
**业务逻辑流程：**
1. 验证取款金额 > 0
2. 更新指数系统
3. 计算用户存款总额（含利息）
4. 验证用户余额充足
5. 处理存款记录（后进先出）：
    - 遍历用户存款记录
    - 计算每条记录的本息总额
    - 按需减少本金或删除记录
6. 更新总存款本金
7. 计算利息收益
8. 转移资金给用户
9. 触发取款事件

### 1.4、depositCollateral - 抵押存款
**业务逻辑流程：**
1. 验证抵押金额 > 0
2. 验证抵押代币是否支持
3. 更新指数系统
4. 转移抵押代币到合约
5. 更新抵押物信息：
    - 增加总抵押数量
    - 增加用户抵押数量
6. 触发抵押事件

### 1.5、depositCollateralWithdraw - 抵押撤回
**业务逻辑流程：**
1. 验证撤回百分比有效
2. 验证抵押代币是否支持
3. 更新指数系统
4. 计算用户信息：
    - 总借款金额（含利息）
    - 最大可借USDC数量
    - 可撤回的USDC价值
5. 计算需要撤回的代币数量
6. 更新抵押物数量：
    - 减少用户抵押数量
    - 减少总抵押数量
7. 转移抵押物回用户
8. 触发抵押撤回事件

### 1.6、borrow - 抵押借款
**业务逻辑流程：**
1. 验证抵押代币支持
2. 验证借款比例有效
3. 验证用户有抵押物
4. 更新指数系统
5. 计算借款能力：
    - 最大可借USDC数量
    - 当前总借款（含利息）
    - 实际可借金额
6. 验证合约流动性充足
7. 更新抵押物借款信息
8. 记录借款记录：
    - 本金金额
    - 借款指数快照
    - 时间戳
9. 增加总借款本金
10. 添加借款人到列表
11. 转移借款给用户
12. 触发借款事件

### 1.7、borrowRepay - 借款还款
**业务逻辑流程：**
1. 验证抵押代币支持
2. 验证用户有借款
3. 更新指数系统
4. 计算还款信息：
    - 总借款金额（含利息）
    - 实际还款金额
5. 从用户转移还款资金到合约
6. 计算并返回抵押物给用户
7. 更新抵押物数量
8. 处理借款记录（后进先出）：
    - 遍历借款记录
    - 按需减少本金或删除记录
9. 触发还款事件

### 1.8、checkLiquidate - 检查可清算用户
**业务逻辑流程：**
1. 验证抵押代币支持
2. 获取该代币的所有借款人列表
3. 遍历每个借款人：
    - 计算健康因子
    - 如果健康因子 < 1（可清算）：
        * 计算债务总额
        * 计算抵押物价值
        * 计算最大清算金额
        * 添加到可清算用户列表
4. 返回可清算用户信息数组

### 1.9、liquidate - 执行清算
**业务逻辑流程：**
1. 验证抵押代币支持
2. 验证清算金额 > 0
3. 更新指数系统
4. 检查借款人健康因子 < 1（可清算）
5. 验证清算金额不超过最大限额
6. 计算清算信息：
    - 抵押物价格
    - USDC价格
    - 清算人可获得抵押物数量
    - 清算奖励金额
7. 验证抵押物充足
8. 从清算人转移USDC到合约
9. 计算借款本金减少额
10. 更新借款记录和总借款
11. 更新抵押物总量
12. 转移抵押物给清算人
13. 触发清算事件

### 1.9、getTokenBorrowable - 计算抵押代币的可借款额度
**业务逻辑流程：**

1. **参数验证**
   - 检查抵押代币是否在支持的抵押物列表中
   - 确保代币地址不为零地址

2. **价格获取**
   - 从Chainlink预言机获取抵押代币的当前价格
   - 从Chainlink预言机获取USDC的当前价格

3. **可借款额度计算**
   - 可借款USDC金额 = (总抵押物价值 - 总借款价值) × 抵押率

### getTokenUtilizationRate - 计算抵押代币的资金利用率
**业务逻辑流程：**

1. **参数验证**
   - 检查抵押代币是否在支持的抵押物列表中
   - 确保代币地址不为零地址

2. **价格获取**
   - 从Chainlink预言机获取抵押代币的当前价格
   - 从Chainlink预言机获取USDC的当前价格

3. **利用率计算**
   - 利用率 = 总借款价值 / 最大可抵押价值

# 二、核心业务
### 2.1、存款业务
1. **存款**
    - 用户存入USDC获得利息收益
    - 记录存款时的流动性指数快照
    - 利息通过指数系统自动累积
2. **取款**
    - 基于后进先出(LIFO)原则处理
    - 实时计算本金+累积利息
    - 按比例减少存款本金记录

### 2.2、抵押借款业务
1. **抵押存款**
    - 用户存入支持的抵押代币
    - 抵押物价值决定借款额度
2. **借款**
    - 基于抵押物价值计算最大可借金额
    - 借款比例受抵押率限制
    - 记录每次借款时的借款指数快照
3. **还款**
    - 偿还USDC借款本金+利息
    - 按比例返还抵押物
    - 后进先出处理借款记录

### 2.3、利息计算系统
**双指数系统：**
- 存款指数 (liquidityIndex)：跟踪存款利息累积
- 借款指数 (borrowIndex)：跟踪借款利息累积

**计算原理：**
1. **利用率计算**
    - 利用率 = 总借款 / 总存款
    - 决定利率水平
2. **动态利率**
    - 借款利率 = f(利用率) ← 基于利用率曲线
    - 存款利率 = 存款利率 = (借款利率 × 利用率) × (1 - 储备金因子)
3. **复利累积**
    - 指数增长：index_new = index_old × (1 + rate × timeDelta)
    - 实时更新，按秒累积

### 2.4、用户利息计算
**存款利息：**
用户存款总额 = Σ(存款本金 × 当前流动性指数 / 存款时流动性指数)

**借款利息：**
用户借款总额 = Σ(借款本金 × 当前借款指数 / 借款时借款指数)

### 2.5、抵押机制
**关键参数：**
- 抵押率 (collateralizationRatio)：决定借款额度
- 清算阈值 (liquidationThreshold)：触发清算的临界点

**借款额度计算：**
最大借款金额 = 抵押物价值 × 抵押率

### 2.6、健康因子系统
**健康因子公式：**
健康因子 = (抵押物价值 × 清算阈值) / 总债务价值

**风险等级：**
- 健康因子 ≥ 1.2：安全（清算后的阈值）
- 健康因子 < 1：可被清算

### 2.7、清算触发条件
**可清算状态：**
- 健康因子 < 1.0
- 抵押物价值不足以覆盖债务

**清算检查：**
- 系统定期扫描所有借款人
- 返回可清算用户列表及详细信息

### 2.8、清算执行流程
1. **清算人操作**
    - 支付债务金额的USDC
    - 获得抵押物作为奖励
2. **清算计算**
    - 最大清算金额 = min(债务总额, 健康因子恢复所需金额)
    - 清算奖励 = 债务对应的抵押物 + 惩罚奖励(10%)
3. **状态更新**
    - 减少借款人债务
    - 转移抵押物给清算人
    - 更新相关统计信息